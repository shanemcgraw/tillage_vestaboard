<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Beacon - Review Message</title>
  <link rel="stylesheet" href="/style.css">
  <style>
    .grid-row {
      display: flex;
      justify-content: center;
    }
    .grid-cell {
      width: 24px;
      height: 32px;
      background: #1a1a1a;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Courier New', monospace;
      font-size: 16px;
      font-weight: bold;
      margin: 1px;
      border-radius: 2px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1><a href="/admin" style="text-decoration: none; color: inherit;">Beacon</a></h1>
      <span class="status-badge status-<%= message.status %>"><%= message.status %></span>
    </div>

    <div class="card">
      <h3>Original Email</h3>
      <p><strong>From:</strong> <%= message.senderName ? `${message.senderName} <${message.senderEmail}>` : message.senderEmail %></p>
      <p><strong>Subject:</strong> <%= message.subject || '(no subject)' %></p>
      <p><strong>Received:</strong> <%= new Date(message.createdAt).toLocaleString() %></p>
      <hr style="margin: 1rem 0; border: none; border-top: 1px solid #eee;">
      <pre style="white-space: pre-wrap; font-family: inherit;"><%= message.rawBody %></pre>
    </div>

    <% if (message.status === 'pending') { %>
      <form method="POST" action="/admin/message/<%= message.id %>/approve">
        <div class="card">
          <h3>Vestaboard Message</h3>
          <p style="color: #666; font-size: 0.9rem; margin-bottom: 1rem;">
            Edit the message below. Text is automatically formatted for the Vestaboard: 6 lines, 22 characters per line, with automatic word wrapping and hyphenation. Only A-Z, 0-9, and basic punctuation are supported.
          </p>
          <textarea
            name="vestaboard_text"
            id="vestaboard-input"
            rows="6"
            maxlength="137"
            style="font-family: 'Courier New', monospace; letter-spacing: 0.1em; font-size: 14px; background: #1a1a1a; color: #fff; padding: 0.75rem; border-radius: 4px; resize: none; line-height: 1.5;"
          ><%= message.vestaboardText %></textarea>

          <h4 style="margin-top: 1.5rem; margin-bottom: 0.5rem;">Preview</h4>
          <div id="vestaboard-preview" class="vestaboard-preview"></div>

          <div class="actions">
            <button type="submit" class="btn success">Approve & Post</button>
            <button type="submit" formaction="/admin/message/<%= message.id %>/reject" class="btn danger">Reject</button>
            <a href="/admin" class="btn secondary">Cancel</a>
          </div>
        </div>
      </form>

      <script>
        const input = document.getElementById('vestaboard-input');
        const preview = document.getElementById('vestaboard-preview');

        const ROWS = 6;
        const COLS = 22;

        // Vestaboard supported characters (uppercase letters, numbers, specific punctuation)
        const VESTABOARD_CHARS = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$()+-&=;:\'"%,./?Â° ';

        // Character replacements for smart quotes, dashes, etc.
        const CHAR_REPLACEMENTS = {
          '\u2018': "'", '\u2019': "'", '\u201C': '"', '\u201D': '"',
          '\u2013': '-', '\u2014': '-', '\u2212': '-',
          '\u2026': '...',
          '\u00A0': ' ', '\t': ' ',
        };

        function normalizeChar(char) {
          if (CHAR_REPLACEMENTS[char]) {
            char = CHAR_REPLACEMENTS[char];
          }
          char = char.toUpperCase();
          return VESTABOARD_CHARS.includes(char) ? char : '';
        }

        function normalizeText(text) {
          if (!text) return '';
          let result = text;
          // Apply character replacements
          for (const [from, to] of Object.entries(CHAR_REPLACEMENTS)) {
            result = result.split(from).join(to);
          }
          result = result.toUpperCase();
          // Replace newlines with spaces for wrapping
          result = result.replace(/\r?\n/g, ' ');
          // Collapse multiple spaces (but preserve single trailing space for typing)
          const hadTrailingSpace = result.endsWith(' ');
          result = result.replace(/\s+/g, ' ').trim();
          // Remove unsupported characters
          result = result.split('').filter(char => VESTABOARD_CHARS.includes(char)).join('');
          // Restore trailing space if user was typing
          if (hadTrailingSpace && result.length > 0) {
            result += ' ';
          }
          return result;
        }

        function wordWrap(text, width, preserveTrailingSpace = false) {
          const hadTrailingSpace = text.endsWith(' ');
          const words = text.trim().split(' ');
          const lines = [];
          let currentLine = '';

          for (const word of words) {
            if (!word) continue;

            // Word longer than line width - split it with hyphen
            if (word.length > width) {
              if (currentLine) {
                lines.push(currentLine);
                currentLine = '';
              }
              // Split long word across lines with hyphenation
              let remaining = word;
              while (remaining.length > width) {
                const breakPoint = width - 1;
                lines.push(remaining.slice(0, breakPoint) + '-');
                remaining = remaining.slice(breakPoint);
              }
              currentLine = remaining;
              continue;
            }

            // Check if word fits on current line
            const testLine = currentLine ? `${currentLine} ${word}` : word;
            if (testLine.length <= width) {
              currentLine = testLine;
            } else {
              lines.push(currentLine);
              currentLine = word;
            }
          }

          if (currentLine) {
            // Add trailing space back if preserving and it fits
            if (preserveTrailingSpace && hadTrailingSpace && currentLine.length < width) {
              currentLine += ' ';
            }
            lines.push(currentLine);
          }

          return lines;
        }

        function transformForVestaboard(text, preserveTrailingSpace = false) {
          const normalized = normalizeText(text);
          let lines = wordWrap(normalized, COLS, preserveTrailingSpace);

          // Truncate to max rows
          if (lines.length > ROWS) {
            lines = lines.slice(0, ROWS);
            // Add ellipsis to last line if truncated
            const lastLine = lines[ROWS - 1];
            if (lastLine.length > COLS - 3) {
              lines[ROWS - 1] = lastLine.slice(0, COLS - 3) + '...';
            } else {
              lines[ROWS - 1] = lastLine + '...';
            }
          }

          // Left-justify each line (no padding needed for editor display)
          return lines;
        }

        function updatePreview() {
          const lines = input.value.split('\n').slice(0, ROWS);

          // Pad to 6 lines
          while (lines.length < ROWS) {
            lines.push('');
          }

          // Build grid
          let html = '';
          lines.forEach(line => {
            // Pad/truncate to 22 chars
            const padded = (line + ' '.repeat(COLS)).substring(0, COLS);
            html += '<div class="grid-row">';
            for (let i = 0; i < COLS; i++) {
              const char = padded[i] || ' ';
              html += `<div class="grid-cell">${char === ' ' ? '&nbsp;' : char}</div>`;
            }
            html += '</div>';
          });

          preview.innerHTML = html;
        }

        // Store raw input for re-formatting
        let rawInput = '';

        // Convert cursor position to character index (ignoring newlines)
        function cursorToCharIndex(text, cursorPos) {
          let charIndex = 0;
          for (let i = 0; i < cursorPos && i < text.length; i++) {
            if (text[i] !== '\n') charIndex++;
          }
          return charIndex;
        }

        // Convert character index back to cursor position (accounting for newlines)
        function charIndexToCursor(text, charIndex) {
          let cursor = 0;
          let chars = 0;
          while (cursor < text.length && chars < charIndex) {
            if (text[cursor] !== '\n') chars++;
            cursor++;
          }
          return cursor;
        }

        // Auto-format input with word wrapping and hyphenation
        input.addEventListener('input', function(e) {
          // Save cursor position before formatting (as character index)
          const cursorPos = this.selectionStart;
          const oldValue = this.value;
          const charIndex = cursorToCharIndex(oldValue, cursorPos);

          // Capture the raw text the user is typing
          rawInput = this.value;

          // Transform to Vestaboard format with word wrapping and hyphenation
          // Preserve trailing space so user can type between words
          const lines = transformForVestaboard(rawInput, true);
          const formatted = lines.join('\n');

          if (formatted !== this.value) {
            this.value = formatted;

            // Restore cursor position based on character index
            const newCursorPos = charIndexToCursor(formatted, charIndex);
            this.setSelectionRange(newCursorPos, newCursorPos);
          }

          updatePreview();
        });

        // Handle paste events to format pasted content
        input.addEventListener('paste', function(e) {
          e.preventDefault();
          const pastedText = (e.clipboardData || window.clipboardData).getData('text');
          rawInput = pastedText;
          const lines = transformForVestaboard(pastedText);
          this.value = lines.join('\n');
          this.setSelectionRange(this.value.length, this.value.length);
          updatePreview();
        });

        updatePreview();
      </script>
    <% } else { %>
      <div class="card">
        <h3>Vestaboard Message</h3>
        <div id="vestaboard-preview" class="vestaboard-preview">
          <% const lines = (message.vestaboardText || '').split('\n'); %>
          <% for (let i = 0; i < 6; i++) { %>
            <div class="grid-row">
              <% const line = (lines[i] || '').padEnd(22, ' ').substring(0, 22); %>
              <% for (let j = 0; j < 22; j++) { %>
                <div class="grid-cell"><%= line[j] === ' ' ? '\u00A0' : line[j] %></div>
              <% } %>
            </div>
          <% } %>
        </div>

        <% if (message.errorMessage) { %>
          <div class="alert error" style="margin-top: 1rem;">
            <strong>Error:</strong> <%= message.errorMessage %>
          </div>
        <% } %>

        <div class="actions">
          <a href="/admin" class="btn secondary">Back to Dashboard</a>
          <% if (message.status === 'failed') { %>
            <form method="POST" action="/admin/message/<%= message.id %>/retry" style="margin: 0;">
              <button type="submit" class="btn primary">Retry Post</button>
            </form>
          <% } %>
        </div>
      </div>
    <% } %>
  </div>
</body>
</html>
